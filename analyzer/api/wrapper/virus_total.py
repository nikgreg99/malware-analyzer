import vt
from vt import Object
from django.conf import settings

from analyzer.api.wrapper.utils import compute_file_sha256


def get_file_attribute(file: Object, param):
    return file.get(param)


class VirusTotalAPI(object):

    def __init__(self, api_key):
        self.client = vt.Client(api_key)

    @staticmethod
    def create(self, api_key):
        if self.instance is None:
            self.instance = VirusTotalAPI(api_key)
        return api_key

    def submit_file(self, file_name: str):
        with open(settings.MEDIA_ROOT + "/" + file_name) as sample:
            signature_sha_256 = compute_file_sha256(sample)
            file = self.client("/files/{}".format(signature_sha_256))
            if file is None:
                return self.client.get_object(sample, wait_for_completion=True)
            else:
                return file

    def submit_url(self, url: str):
        analysis = self.client.scan_url(url)
        return analysis
