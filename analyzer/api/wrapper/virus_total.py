import requests
import urllib.parse

from analyzer.api.wrapper.utils import compute_file_sha256, connect
from storage import upload_storage


class VirusTotalAPI(object):
    base_url = "https://www.virustotal.com/api/v3/"

    def __init__(self, api_key):
        self.session = requests.Session()
        self.session.headers = {
            'x-apikey': api_key
        }

    @staticmethod
    def create(api_key):
        return VirusTotalAPI(api_key)

    def submit_file(self, file_name):
        files = {"file": upload_storage.open(file_name, 'rb')}
        return connect(self.session, "POST", urllib.parse.urljoin(self.base_url, "files"), files=files)

    def get_file_report(self, file_id):
        return connect(self.session, "GET", urllib.parse.urljoin(self.session, "files/{}".format(file_id)))



