from analyzer.api import HybridAnalysisAPIEnvironment
from analyzer.models import Target, Analyse, Sandbox
from instances import *


def submit_file_dispatcher(file: str, sandbox: Sandbox, analyse_environment=HybridAnalysisAPIEnvironment.WIN7_64_BIT):
    dispatcher = {
        Sandbox.HYBRID_ANALYSIS: hybrid_analysis_client.submit_file(file, analyse_environment),
        Sandbox.CUCKOO: cuckoo_client.submit_file(),
        Sandbox.FILE_SCAN_IO: file_scan_io_client.submit_file(file),
        Sandbox.VIRUS_TOTAL: virus_total_client.submit_file(file)
    }
    return dispatcher.get(sandbox)


def submit_url_dispatcher(url: str, sandbox: Sandbox, analyse_environment=HybridAnalysisAPIEnvironment.WIN7_64_BIT):
    dispatcher = {
        Sandbox.HYBRID_ANALYSIS: hybrid_analysis_client.submit_url(url, analyse_environment),
        Sandbox.CUCKOO: cuckoo_client.submit_url(url),
        Sandbox.FILE_SCAN_IO: file_scan_io_client.submit_file(url),
        Sandbox.VIRUS_TOTAL: virus_total_client.submit_file(url)
    }
    return dispatcher.get(sandbox)


def save_hybrid_analysis_analyse(target_id: Target, json_analyse):
    size = json_analyse['size']
    type = json_analyse['type_short']
    MD5 = json_analyse['md5']
    SHA1 = json_analyse['sha1']
    SHA256 = json_analyse['sha256']
    SHA512 = json_analyse['sha512']
    analyse_start_time = json_analyse['analysis_start_time']
    analyse = Analyse(sandbox=Sandbox.HYBRID_ANALYSIS,
                      size=size,
                      type=type,
                      MD5=MD5,
                      SHA1=SHA1,
                      SHA256=SHA256,
                      SHA512=SHA512,
                      analyse_start_time=analyse_start_time,
                      target=Target.objects.get(id=target_id))
    analyse.save()
