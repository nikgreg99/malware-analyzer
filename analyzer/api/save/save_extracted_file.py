from analyzer.models import Overview
from analyzer.models.extracted_file import ExtractedFile


def save_extracted_file_if_not_exists(file: dict):
    digests = file['digests']
    meta_data = file['metaData']
    extended_data = file['extendedData']
    origin = file['origin']
    media_type = file['mediaType']

    submit_name = file['submitName']
    size = file['fileSize']
    MD5 = digests['MD5']
    SHA1 = digests['SHA-1']
    SHA256 = digests['SHA-256']
    SHA512 = digests['SHA-512']
    description = extended_data['fileMagicDescription']
    ssdeep = extended_data['ssdeep']
    entropy = meta_data['entropy']
    resource_id = meta_data['resourceID']
    origin_type = origin['type']
    string = media_type['string']

    file_row, created = ExtractedFile.objects.get_or_create(submit_name=submit_name, size=size, MD5=MD5, SHA1=SHA1,
                                                            SHA256=SHA256, SHA512=SHA512, entropy=entropy,
                                                            ssdeep=ssdeep, origin=origin_type, media_type=string,
                                                            description=description, resource_id=resource_id)

    return file_row


def save_extracted_files(overview: Overview, files: dict):
    for file in files:
        file_row = save_extracted_file_if_not_exists(file)
        overview.extracted_files.add(file_row)
