from analyzer.models import CharReadable, Overview
from analyzer.models.section import Section


def save_characteristics_readable(characteristic_readable: str):
    char_readable = CharReadable().objects.filter(name=characteristic_readable)
    if not char_readable.exists():
        char_readable = CharReadable(name=characteristic_readable)
        char_readable.save()
    else:
        char_readable = char_readable.get()
    return char_readable


def save_section(dict_section: dict):
    name = dict_section['name']
    va = dict_section['va']
    file_rva = dict_section['fileRva']
    virtual_size = dict_section['virtualSize']
    size_of_raw_data = dict_section['sizeOfRawData']
    MD5 = dict_section['md5']
    entropy = dict_section['entropy']
    characteristics = dict_section['characteristics']

    section = Section.objects.filter(name=name, va=va, file_rva=file_rva, virtual_size=virtual_size,
                                     size_raw_data=size_of_raw_data,
                                     MD5=MD5, entropy=entropy, characteristics=characteristics)

    if not section.exists():
        section = Section(name=name, va=va, file_rva=file_rva, virtual_size=virtual_size,
                          size_raw_data=size_of_raw_data,
                          MD5=MD5, entropy=entropy, characteristics=characteristics)
        section.save()

    else:
        section = section.get()

    characteristics_readable = dict_section['characteristicsReadable']
    for characteristic_readable in characteristics_readable:
        char_readable = save_characteristics_readable(characteristic_readable)
        section.char_readable.add(char_readable)
    return section


def save_sections(overview: Overview, dict_sections: dict):
    for dict_section in dict_sections:
        section = save_section(dict_section)
        overview.sections.add(section)
