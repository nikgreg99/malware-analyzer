from analyzer.models import Summary
from analyzer.models.resource import Resource


def save_resource_if_not_exists(dict_resource: dict):
    type = dict_resource['type']
    name = dict_resource['name']
    id = dict_resource['id']
    rva = dict_resource['rva']
    file_rva = dict_resource['fileRva']
    size = dict_resource['size']
    SHA256 = dict_resource['sha256']
    file_description = dict_resource['fileMagicDescription']
    lang = dict_resource['lang']
    sub_lang = dict_resource['sublang']

    resource, created = Resource.objects.get_or_create(type=type, name=name, id_resource=id, rva=rva,
                                                       file_rva=file_rva, size=size, SHA256=SHA256,
                                                       file_description=file_description, lang=lang, sublang=sub_lang)

    return resource


def save_resources(overview: Summary, dict_resources):
    for dict_resource in dict_resources:
        resource = save_resource_if_not_exists(dict_resource)
        overview.resources.add(resource)


def save_resources_virus_total_api(summary: Summary, resources):
    for resource in resources:
        file_type = resource['filetype']
        type = resource['type']
        lang = resource['lang']
        sha_256 = resource['sha256']
        resource_row, created = Resource.objects.get_or_create(name=file_type, type=type, lang=lang, SHA256=sha_256)
        summary.resources.add(resource_row)


def save_resources_cuckoo_api(summary: Summary, resources: list):
    for resource in resources:
        name = resource['name']
        lang = resource['language']
        file_type = resource['filetype']
        sub_lang = resource['sublanguage']
        offset = resource['offset']
        size = resource['size']
        resource_row, created = Resource.objects.get_or_create(name=name, type=file_type, lang=lang,
                                                               sublang=sub_lang, size=size, file_rva=offset)
        summary.resources.add(resource_row)
