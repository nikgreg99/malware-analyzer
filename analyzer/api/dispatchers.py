from time import sleep

from .save.save_domain import save_domains
from .save.save_mitre_rules import save_mitre_rules
from .save.save_process import save_processes
from .save.save_screenshot import save_screenshots
from .save.save_tag import save_tags
from .wrapper.hybrid_analysis import HybridAnalysisAPI, HybridAnalysisAPIEnvironment
from .wrapper.file_scan_io import FileScanIOAPI
from .wrapper.virus_total import VirusTotalAPI
from .wrapper.cuckoo import CuckooAPI
from analyzer.models import Sandbox, Target, Overview
from analyzer.api.save.save_overview import  save_overview_file_scan_io

hybrid_analysis = HybridAnalysisAPI.create("nsf7gnhmada16034ttqw85ul11b17cf0rbb80wigee02e9c9fahch10if8caa7d5")
file_scan_io = FileScanIOAPI.create("zmtIFIh9vKhRNqNS5njousQCCPLQfat6pqEmIoNS")
cuckoo = CuckooAPI.create(host="193.246.121.179", port=8090, api_key="RY_aUdiMgUJNuu8ZeSukWQ")
virus_total = VirusTotalAPI.create("dfddc81d41862fe2a03bc73475d15fbb004993a7f7cc4b9948711d38769a7d3e")


class SubmitURLDispatcher(object):

    def submit_url_Cuckoo(self, url: str):
        return cuckoo.submit_url(url)

    def submit_url_Hybrid_Analysis(self, url: str, environment_id):
        return hybrid_analysis.submit_url(url, environment_id)

    def submit_url_FileScanIO(self, url: str):
        return file_scan_io.submit_url(url)

    def submit_url_virus_total(self, url: str):
        return file_scan_io.submit_url(url)

    def submit_url(self, url: str, sandbox: str, environment_id=None):
        method_name = 'submit_url_' + sandbox
        method = getattr(self, method_name, lambda: 'Invalid sandbox name')
        if sandbox != "Hybrid_Analysis":
            return method(url)
        else:
            return method(url, environment_id)


class SubmitFileDispatcher(object):

    def submit_file_Hybrid_Analysis(self, file_name: str, environment_id):
        return hybrid_analysis.submit_file(file_name, environment_id)

    def submit_file_Cuckoo(self, file_name: str):
        return cuckoo.submit_file(file_name)

    def submit_file_FileScanIO(self, file_name: str):
        return file_scan_io.submit_file(file_name)

    def submit_file_Virus_Total(self, file_name: str):
        return virus_total.submit_file(file_name)

    def submit_file(self, file_name: str, sandbox: str, environment_id=None):
        method_name = 'submit_file_' + sandbox
        method = getattr(self, method_name, lambda: 'Invalid sandbox name')
        if sandbox != "Hybrid_Analysis":
            return method(file_name)
        else:
            return method(file_name, environment_id)


class AnalyseIDDispatcher(object):

    def get_analyse_id_Cuckoo(self, json_response: dict):
        return json_response['task_id']

    def get_analyse_id_Hybrid_Analysis(self, json_response: dict):
        return json_response['job_id']

    def get_analyse_id_FileScanIO(self, json_response: dict):
        return json_response['flow_id']

    def get_analyse_id_Virus_Total(self, json_response: dict):
        return json_response['data']['id']

    def get_analyse_id(self, sandbox: str, json_response: dict):
        method_name = 'get_analyse_id_' + sandbox
        method = getattr(self, method_name, lambda: 'Invalid sandbox name')
        return method(json_response)


def download_report_analyse(job_id: str, sandbox: str, report_format: str):
    if sandbox == Sandbox.HYBRID_ANALYSIS:
        return hybrid_analysis.report_id_download_type(job_id, report_format)

    if sandbox == Sandbox.FILE_SCAN_IO:
        return file_scan_io.download_report(job_id, report_format)


def save_analyse_file(target, sandbox):
    target_name_str = target.name.name

    id_hybrid_analysis = SubmitFileDispatcher().submit_file(target_name_str, 'Hybrid_Analysis', HybridAnalysisAPIEnvironment.WIN7_64_BIT)[
        'job_id']
    id_file_scanIO = SubmitFileDispatcher().submit_file(target_name_str, 'FileScanIO')['flow_id']

    sleep(25)  # previously
    overview_report_file_scan_io = file_scan_io.get_reports_by_id(id_file_scanIO)
    report_hybrid_analysis = hybrid_analysis.report_id_summary(id_hybrid_analysis)

    analyse = save_overview_file_scan_io(target, overview_report_file_scan_io)
    save_screenshots(analyse, hybrid_analysis.report_id_screenshots(id_hybrid_analysis))
    save_processes(analyse, report_hybrid_analysis['processes'])
    save_tags(analyse, report_hybrid_analysis['classification_tags'])
    save_domains(analyse, report_hybrid_analysis['domains'])
    save_mitre_rules(analyse, report_hybrid_analysis['mitre_attcks'])
    return analyse


def save_analyse_url(url, sandbox):
    analyse = none
    id_hybrid_analysis = \
    SubmitURLDispatcher().submit_url(url, 'Hybrid_Analysis', HybridAnalysisAPIEnvironment.WIN7_64_BIT)['job_id']
    id_file_scan_IO = SubmitURLDispatcher().submit_url(url, 'FileScanIO')['flow_id']

    return analyse
