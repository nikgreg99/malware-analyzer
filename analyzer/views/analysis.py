from django.core.paginator import Paginator
from django.shortcuts import render
from django.views import View
from django.conf import settings
from analyzer.models import Target

# STATUS: OK
from analyzer.models.report import Report


class AnalysisView(View):
    def get(self, request, *args, **kwargs):
        reports = Report.objects.all()
        if request.GET.get('q'):
            keyword = request.GET.get('q')
            try:
                targets = Target.objects.filter(name__startswith=keyword)
                reports = reports.filter(target__in=[target for target in targets])
            except Target.DoesNotExist:
                return render(request, "analyzer/analysis.html", context={})

        reports = reports.order_by('-submit_date_time')
        item_per_page = settings.GLOBAL_SETTINGS['item_per_page']
        paginator = Paginator(reports, item_per_page)
        page_number = request.GET.get('page')
        page_obj = paginator.get_page(page_number)
        context = {
            'analysis': page_obj,
            'item_per_page': item_per_page
        }

        return render(request, "analyzer/analysis.html", context=context)
