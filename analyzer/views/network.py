import os.path
from django.shortcuts import render, get_object_or_404
from django.conf import settings
from scapy.all import *
from scapy.layers.inet import IP

from analyzer.models.report import Report
from analyzer.views.utils import get_file_in_response, get_sandbox_report


def download_pcap(request, report_id, sandbox):
    report = get_object_or_404(Report, pk=report_id)
    overview = get_sandbox_report(report, sandbox)
    pcap_file = overview.network_analysis.pcap_file
    pcap_file_path = pcap_file.path
    pcap_file_name = pcap_file.name
    if os.path.exists(pcap_file_path):
        with open(pcap_file_path, 'rb') as f:
            pcap_content = f.read()
        return get_file_in_response(pcap_content, pcap_file_path, pcap_file_name)


def get_network_analysis(request, report_id, sandbox):
    report = get_object_or_404(Report, pk=report_id)
    overview = get_sandbox_report(report, sandbox)
    packets = []
    if overview.network_analysis is not None:
        pcap_file = overview.network_analysis.pcap_file.url
        for pkt in rdpcap(settings.PROJECT_PATH + pcap_file):
            if IP in pkt:
                pkt_src = pkt[IP].src
                pkt_dst = pkt[IP].dst
                packets.append({
                    'src': pkt_src,
                    'dst': pkt_dst,
                })

    context = {
        'report': report,
        'overview': overview,
        'packets': packets,
        'sandbox': sandbox
    }
    return render(request, 'analyzer/network.html', context=context)
