import pathlib
from glob import glob

from django.http import Http404
from django.shortcuts import render, get_object_or_404, redirect
from django.conf import settings
from analyzer.api.dispatchers import download_report_analyse
from analyzer.models import Overview, Sandbox
from analyzer.views.utils import get_file_in_response

from storage import report_storage

report_format_dispatcher = {
    Sandbox.HYBRID_ANALYSIS: ['json', 'html', 'pdf', 'maec', 'stix', 'misp', 'misp-json', 'openioc'],
    Sandbox.FILE_SCAN_IO: ['html', 'pdf', 'stix', 'misp'],
    Sandbox.CUCKOO: ['json', 'html', 'all', 'dropped', 'packaged_files']
}


def get_analyse_overview(request, overview_id):
    try:
        overview = get_object_or_404(Overview, pk=overview_id)
    except Overview.DoesNotExist:
        raise Http404
    context = {
        'overview': overview,
        'report_formats': report_format_dispatcher.get(overview.sandbox)
    }
    return render(request, "analyzer/overview.html", context)


def download_sample(request, overview_id):
    analyse = Overview.objects.filter(pk=overview_id).get()
    file = analyse.target.name
    response = get_file_in_response(file, file.url, file.name)
    file.close()
    return response


def download_report(request, overview_id, report_format):
    analyse = Overview.objects.filter(pk=overview_id).get()
    job_id = analyse.job_id
    report_name = '%s.%s' % (job_id, report_format)
    if not report_storage.exists(report_name):
        response = download_report_analyse(job_id, analyse.sandbox, report_format)
        file = report_storage.open(report_name, 'wb')
        content = response.content
        try:
            file.write(content)
        finally:
            file.close()
    else:
        file = report_storage.open(report_name, 'rb')
        try:
            content = file.read()
        finally:
            file.close()
    report_path = pathlib.Path(report_name).parent.absolute()
    response = get_file_in_response(content, report_path, report_name)
    return response


def delete_analyse(request, overview_id):
    overview = Overview.objects.filter(pk=overview_id).get()
    regex = settings.REPORT_ROOT.join('/%s.*' % overview.job_id)
    for report in glob(regex):
        report_storage.delete(report)
    overview.delete()
    response = redirect("/analyzer")
    return response
