from django.core.paginator import Paginator
from django.http import JsonResponse
from django.shortcuts import render
from django.views import View
from django.conf import settings

from analyzer.models import Overview, Target


class ListView(View):
    def get(self, request, *args, **kwargs):

        if request.GET.get('q'):
            target_to_search = request.GET.get('q')
            target = Target.objects.filter(name__contains=target_to_search).get()
            analysis = Overview.objects.filter(target=target.pk)

        else:
            analysis = Overview.objects.all()

        analysis = analysis.order_by('-submission_time')
        item_per_page = settings.GLOBAL_SETTINGS['item_per_page']
        paginator = Paginator(analysis, item_per_page)
        page_number = request.GET.get('page')
        page_obj = paginator.get_page(page_number)

        context = {
            'analysis': page_obj,
            'item_per_page': item_per_page
        }

        return render(request, "analyzer/list.html", context=context)
