from django.conf import settings
from django.shortcuts import render, get_object_or_404, redirect

from analyzer.models import Overview
from analyzer.views.overview import delete_file_by_regex
from storage import report_storage


def get_options(request, overview_id):
    overview = get_object_or_404(Overview, pk=overview_id)
    context = {
        'overview': overview
    }
    return render(request, 'analyzer/options.html', context=context)


def delete_analyse(request, overview_id):
    overview = Overview.objects.get(pk=overview_id)
    screenshots = overview.screenshots.all()

    for screenshot in screenshots:
        screenshot.image.delete(save=True)
        screenshot.delete()

    delete_file_by_regex(settings.REPORT_ROOT.join('/%s.*' % overview.job_id), report_storage)
    overview.delete()
    return redirect('analyzer:analysisList')

