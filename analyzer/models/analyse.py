from enum import Enum

from django.db import models
from django.utils.translation import gettext_lazy as _

from .target import Target

from .utils import get_string_or_not_found


class Sandbox(Enum):
    CUCKOO = "Cuckoo"
    HYBRID_ANALYSIS = "Hybrid Analysis"
    FILE_IO = "FileIO"
    VIRUS_TOTAL = "VIRUS TOTAL"

    @classmethod
    def choices(cls):
        return [(key.name, key.value) for key in cls]


class Analyse(models.Model):
    class Meta:
        verbose_name = _("analyse_sandbox")
        verbose_name_plural = _("analyse_sandboxes")

    target = models.ForeignKey(Target, on_delete=models.CASCADE, null=True)
    sandbox = models.CharField(_("analyse_sandbox"), max_length=30, choices=Sandbox.choices(), default=Sandbox.CUCKOO)
    size = models.IntegerField(default=None)
    type = models.CharField(max_length=200, default="", blank=True)
    MD5 = models.CharField(max_length=200, default="", blank=True)
    SHA1 = models.CharField(max_length=200, default="", blank=True)
    SHA256 = models.CharField(max_length=200, default="", blank=True)
    SHA512 = models.CharField(max_length=200, default="", blank=True)
    CRC32 = models.IntegerField(default=0, blank=True)
    analyse_start_time = models.DateTimeField("analyse_start_time")
    ssdeep = models.CharField(max_length=148, default="", blank=True)
    strings = models.TextField(max_length=400, default="", blank=True)

    @property
    def has_MD5(self):
        return get_string_or_not_found(self.MD5)

    @property
    def has_SHA1(self):
        return get_string_or_not_found(self.SHA1)

    @property
    def has_SHA256(self):
        return get_string_or_not_found(self.SHA256)

    @property
    def has_SHA512(self):
        return get_string_or_not_found(self.SHA512)

    @property
    def has_ssdeep(self):
        return get_string_or_not_found(self.ssdeep)
